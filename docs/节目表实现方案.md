# 节目表实现方案

## 1. 需求分析

### 1.1 功能需求
- **导航栏集成**: 在现有导航栏新增"节目单"页面入口
- **EPG数据源**: 支持用户配置节目单地址，默认使用 `http://epg.51zmt.top:8000/e.xml.gz`
- **数据格式**: 支持GZIP压缩的XMLTV格式电子节目单
- **数据更新**: 
  - 手动刷新：前端提供刷新按钮触发后端重新解析
  - 自动更新：每天早上7点自动更新一次
- **展示功能**:
  - 按分类查看频道节目表
  - 高亮显示当前正在播放的内容
  - 支持查看单个频道的详细节目表
  - 提供整体页面展示所有频道当前正在播出的内容

### 1.2 技术需求
- **后端**: .NET后端负责数据获取、解析和缓存
- **前端**: React + Ant Design组件实现展示界面
- **性能**: 支持大数据量的流式解析和缓存优化
- **可靠性**: 完善的错误处理和重试机制

## 2. 技术架构设计

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (React)   │    │   后端 (.NET)    │    │   EPG数据源     │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 节目单页面   │ │◄──►│ │ EPG API服务  │ │◄──►│ │ XMLTV文件   │ │
│ │             │ │    │ │             │ │    │ │             │ │
│ │ ┌─────────┐ │ │    │ │ ┌─────────┐ │ │    │ └─────────────┘ │
│ │ │频道列表 │ │ │    │ │ │解析服务 │ │ │    │                 │
│ │ └─────────┘ │ │    │ │ └─────────┘ │ │    │ ┌─────────────┐ │
│ │             │ │    │ │             │ │    │ │ GZIP压缩    │ │
│ │ ┌─────────┐ │ │    │ │ ┌─────────┐ │ │    │ │             │ │
│ │ │当前节目 │ │ │    │ │ │缓存服务 │ │ │    │ └─────────────┘ │
│ │ └─────────┘ │ │    │ │ └─────────┘ │ │    │                 │
│ │             │ │    │ │             │ │    └─────────────────┘
│ │ ┌─────────┐ │ │    │ │ ┌─────────┐ │ │
│ │ │刷新按钮 │ │ │    │ │ │定时任务 │ │ │
│ │ └─────────┘ │ │    │ │ └─────────┘ │ │
│ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘
```

### 2.2 后端服务设计

#### 2.2.1 核心服务接口
```csharp
public interface IEpgService
{
    Task<List<EpgChannel>> GetChannelsAsync();
    Task<List<EpgProgram>> GetChannelProgramsAsync(string channelId);
    Task<List<CurrentProgramInfo>> GetCurrentProgramsAsync();
    Task RefreshEpgDataAsync();
    Task<List<string>> GetCategoriesAsync();
    Task<List<EpgChannel>> GetChannelsByCategoryAsync(string category);
}
```

#### 2.2.2 数据模型
```csharp
public class EpgChannel
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string? IconUrl { get; set; }
    public List<string> Categories { get; set; }
    public string? Language { get; set; }
    public string? Country { get; set; }
}

public class EpgProgram
{
    public string Id { get; set; }
    public string ChannelId { get; set; }
    public string Title { get; set; }
    public string? Description { get; set; }
    public DateTime StartTime { get; set; }
    public DateTime EndTime { get; set; }
    public string? Category { get; set; }
    public List<string> Categories { get; set; }
    // ... 其他属性
}

public class CurrentProgramInfo
{
    public EpgChannel Channel { get; set; }
    public EpgProgram CurrentProgram { get; set; }
    public double Progress { get; set; }
    public int RemainingMinutes { get; set; }
}
```

## 3. 详细实现方案

### 3.1 后端实现

#### 3.1.1 XMLTV解析服务
```csharp
public class XmlTvParserService : IXmlTvParserService
{
    public async Task<EpgDataCache> ParseXmlTvAsync(Stream xmlStream)
    {
        // 使用XmlReader进行流式解析，避免内存占用过大
        // 解析频道信息和节目单
        // 支持GZIP解压
        // 处理时区转换
    }
}
```

#### 3.1.2 EPG服务实现
```csharp
public class EpgService : IEpgService
{
    // 实现数据获取、缓存、查询逻辑
    // 支持按分类筛选
    // 计算当前播放进度
}
```

#### 3.1.3 后台更新服务
```csharp
public class EpgUpdateBackgroundService : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        // 每天早上7点执行更新
        // 支持首次启动立即更新
        // 错误处理和重试机制
    }
}
```

#### 3.1.4 API端点
```
GET /api/epg/channels                    - 获取所有频道
GET /api/epg/channels/{id}/programs     - 获取频道节目单
GET /api/epg/current-programs           - 获取当前所有频道节目
GET /api/epg/categories                  - 获取分类列表
GET /api/epg/categories/{category}/channels - 按分类获取频道
POST /api/epg/refresh                    - 手动刷新EPG数据
GET /api/epg/status                      - 获取EPG状态
```

### 3.2 前端实现

#### 3.2.1 路由设计
```typescript
// 在现有路由基础上添加EPG相关路由
const routes = [
  // ... 现有路由
  {
    path: '/epg',
    element: <EpgLayout />,
    children: [
      { path: '', element: <EpgOverviewPage /> },
      { path: 'channels', element: <EpgChannelsPage /> },
      { path: 'channels/:channelId', element: <EpgChannelPage /> },
      { path: 'current', element: <EpgCurrentPage /> },
      { path: 'categories', element: <EpgCategoriesPage /> },
      { path: 'categories/:category', element: <EpgCategoryChannelsPage /> }
    ]
  }
];
```

#### 3.2.2 主要组件设计

**EPG概览页面 (EpgOverviewPage)**
```typescript
const EpgOverviewPage: React.FC = () => {
  return (
    <div>
      <PageHeader title="节目单概览" />
      <Row gutter={[16, 16]}>
        <Col span={8}>
          <Card title="频道总数" extra={<Link to="/epg/channels">查看全部</Link>}>
            <Statistic value={channelCount} />
          </Card>
        </Col>
        <Col span={8}>
          <Card title="当前播放" extra={<Link to="/epg/current">查看全部</Link>}>
            <Statistic value={currentProgramCount} />
          </Card>
        </Col>
        <Col span={8}>
          <Card title="最后更新" extra={<Button onClick={handleRefresh}>刷新</Button>}>
            <Statistic value={lastUpdateTime} formatter={formatDateTime} />
          </Card>
        </Col>
      </Row>
      
      {/* 热门频道当前节目 */}
      <Card title="热门频道当前节目" style={{ marginTop: 16 }}>
        <CurrentProgramsGrid programs={currentPrograms} />
      </Card>
    </div>
  );
};
```

**频道列表页面 (EpgChannelsPage)**
```typescript
const EpgChannelsPage: React.FC = () => {
  return (
    <div>
      <PageHeader 
        title="频道列表" 
        extra={
          <Space>
            <Select 
              placeholder="选择分类" 
              allowClear
              onChange={handleCategoryChange}
              options={categories}
            />
            <Button icon={<ReloadOutlined />} onClick={handleRefresh}>
              刷新
            </Button>
          </Space>
        }
      />
      
      <Table
        columns={[
          { title: '频道', dataIndex: 'name', key: 'name' },
          { title: '分类', dataIndex: 'categories', key: 'categories', render: renderCategories },
          { title: '当前节目', dataIndex: 'currentProgram', key: 'currentProgram', render: renderCurrentProgram },
          { title: '操作', key: 'action', render: renderActions }
        ]}
        dataSource={channels}
        loading={loading}
        rowKey="id"
      />
    </div>
  );
};
```

**频道详情页面 (EpgChannelPage)**
```typescript
const EpgChannelPage: React.FC = () => {
  const { channelId } = useParams();
  const programs = getChannelPrograms(channelId);
  const currentTime = dayjs();
  
  return (
    <div>
      <PageHeader 
        title={`${channel.name} 节目表`}
        extra={<Button onClick={() => navigate('/epg/channels')}>返回列表</Button>}
      />
      
      <Card>
        <Timeline>
          {programs.map(program => {
            const isCurrent = currentTime.isAfter(program.startTime) && 
                            currentTime.isBefore(program.endTime);
            const isPast = currentTime.isAfter(program.endTime);
            
            return (
              <Timeline.Item
                key={program.id}
                color={isCurrent ? 'green' : isPast ? 'gray' : 'blue'}
                dot={isCurrent ? <ClockCircleOutlined /> : undefined}
              >
                <div style={{ 
                  padding: 12, 
                  background: isCurrent ? '#f6ffed' : 'transparent',
                  border: isCurrent ? '1px solid #b7eb8f' : 'none',
                  borderRadius: 6
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <Typography.Title level={4} style={{ margin: 0 }}>
                      {program.title}
                    </Typography.Title>
                    <div>
                      {isCurrent && <Tag color="green">正在播放</Tag>}
                      <Tag>{program.category}</Tag>
                    </div>
                  </div>
                  <div style={{ color: '#666', marginTop: 8 }}>
                    {dayjs(program.startTime).format('HH:mm')} - 
                    {dayjs(program.endTime).format('HH:mm')}
                    <span style={{ marginLeft: 16 }}>
                      时长: {dayjs(program.endTime).diff(dayjs(program.startTime), 'minute')}分钟
                    </span>
                  </div>
                  {program.description && (
                    <Typography.Paragraph style={{ marginTop: 12 }}>
                      {program.description}
                    </Typography.Paragraph>
                  )}
                </div>
              </Timeline.Item>
            );
          })}
        </Timeline>
      </Card>
    </div>
  );
};
```

**当前所有节目页面 (EpgCurrentPage)**
```typescript
const EpgCurrentPage: React.FC = () => {
  const currentPrograms = getCurrentPrograms();
  const groupedByCategory = groupByCategory(currentPrograms);
  
  return (
    <div>
      <PageHeader 
        title="当前所有频道节目"
        extra={
          <Space>
            <Button icon={<ReloadOutlined />} onClick={handleRefresh}>
              刷新
            </Button>
            <AutoRefreshSwitch checked={autoRefresh} onChange={setAutoRefresh} />
          </Space>
        }
      />
      
      {Object.entries(groupedByCategory).map(([category, programs]) => (
        <Card key={category} title={category} style={{ marginBottom: 16 }}>
          <Row gutter={[16, 16]}>
            {programs.map(program => (
              <Col key={program.channel.id} xs={24} sm={12} md={8} lg={6} xl={4}>
                <CurrentProgramCard program={program} />
              </Col>
            ))}
          </Row>
        </Card>
      ))}
    </div>
  );
};
```

#### 3.2.3 导航栏集成
```typescript
// 在现有导航栏中添加EPG菜单项
const NavigationMenu: React.FC = () => {
  const items = [
    // ... 现有菜单项
    {
      key: '/epg',
      icon: <CalendarOutlined />,
      label: '节目单',
      children: [
        { key: '/epg', label: '概览' },
        { key: '/epg/channels', label: '频道列表' },
        { key: '/epg/current', label: '当前节目' },
        { key: '/epg/categories', label: '分类浏览' }
      ]
    }
  ];
  
  return <Menu items={items} selectedKeys={[location.pathname]} />;
};
```

### 3.3 配置支持

#### 3.3.1 后端配置
在 `appsettings.json` 中添加EPG配置：
```json
{
  "Epg": {
    "Url": "http://epg.51zmt.top:8000/e.xml.gz",
    "DownloadTimeoutSeconds": 300,
    "CacheSizeLimit": 104857600,  // 100MB
    "UpdateTime": "07:00"          // 每天早上7点更新
  }
}
```

#### 3.3.2 前端状态管理
```typescript
// 创建EPG数据上下文
interface EpgContextType {
  channels: EpgChannel[];
  currentPrograms: CurrentProgramInfo[];
  categories: string[];
  lastUpdateTime: DateTime | null;
  loading: boolean;
  error: string | null;
  
  // 操作方法
  refreshEpgData: () => Promise<void>;
  getChannelPrograms: (channelId: string) => EpgProgram[];
  getChannelsByCategory: (category: string) => EpgChannel[];
}

const EpgContext = createContext<EpgContextType>(...);
```

## 4. 性能优化

### 4.1 后端优化
- **流式解析**: 使用XmlReader进行流式XML解析，避免内存溢出
- **数据缓存**: 使用内存缓存，频道信息缓存15分钟，节目信息缓存5分钟
- **增量更新**: 支持增量更新机制，只更新变化的数据
- **并发控制**: 限制同时进行的解析任务数量

### 4.2 前端优化
- **虚拟滚动**: 对于大量频道列表使用虚拟滚动
- **分页加载**: 节目单支持分页加载
- **图片懒加载**: 频道图标使用懒加载
- **防抖刷新**: 刷新按钮添加防抖机制

### 4.3 网络优化
- **数据压缩**: API响应启用GZIP压缩
- **缓存策略**: 合理的HTTP缓存头设置
- **请求合并**: 批量请求减少网络开销

## 5. 错误处理

### 5.1 后端错误处理
```csharp
try
{
    var epgData = await parserService.ParseXmlTvAsync(stream);
    await epgService.SaveEpgDataAsync(epgData);
}
catch (HttpRequestException ex)
{
    logger.LogError(ex, "下载EPG数据失败");
    // 使用缓存数据或返回错误信息
}
catch (XmlException ex)
{
    logger.LogError(ex, "解析XMLTV数据失败");
    // 记录详细错误信息，便于调试
}
catch (Exception ex)
{
    logger.LogError(ex, "EPG处理过程中发生未知错误");
    // 通用错误处理
}
```

### 5.2 前端错误处理
```typescript
const refreshEpgData = async () => {
  try {
    setLoading(true);
    setError(null);
    await epgService.refreshEpgData();
    message.success('EPG数据刷新成功');
  } catch (error) {
    logger.error('EPG数据刷新失败', error);
    setError(error.message || '刷新失败，请稍后重试');
    message.error('EPG数据刷新失败');
  } finally {
    setLoading(false);
  }
};
```

## 6. 安全考虑

### 6.1 数据验证
- **URL验证**: 验证EPG地址的合法性
- **XML验证**: 验证XMLTV格式的正确性
- **数据大小限制**: 限制单次解析的数据大小

### 6.2 访问控制
- **API限流**: 对EPG相关API实施限流
- **权限验证**: 确保只有授权用户可以访问EPG数据

### 6.3 数据安全
- **敏感信息过滤**: 过滤可能包含敏感信息的内容
- **XSS防护**: 前端对用户输入进行转义

## 7. 部署方案

### 7.1 环境要求
- **.NET 8.0+**: 后端运行环境
- **Node.js 18+**: 前端构建环境
- **内存**: 建议至少2GB内存用于缓存
- **存储**: 需要足够的临时存储空间用于下载和解析

### 7.2 配置步骤
1. 配置EPG数据源地址
2. 设置更新时间和频率
3. 配置缓存大小和过期时间
4. 设置日志级别和输出路径

### 7.3 监控指标
- **数据更新成功率**: 监控EPG数据更新是否成功
- **解析性能**: 监控XMLTV解析耗时
- **API响应时间**: 监控EPG相关API的响应性能
- **内存使用率**: 监控EPG服务内存占用情况

## 8. 测试方案

### 8.1 单元测试
- **XMLTV解析测试**: 验证各种XMLTV格式的正确解析
- **数据模型测试**: 验证数据转换和缓存逻辑
- **API测试**: 验证API接口的正确性和性能

### 8.2 集成测试
- **端到端测试**: 验证完整的EPG数据获取和展示流程
- **性能测试**: 验证大数据量下的系统性能
- **异常测试**: 验证各种异常情况的处理

### 8.3 用户验收测试
- **功能测试**: 验证所有功能需求是否满足
- **易用性测试**: 验证用户界面的友好性
- **兼容性测试**: 验证在不同设备和浏览器上的表现

## 9. 监控与维护

### 9.1 日志监控
- **更新日志**: 记录每次EPG数据更新的详细情况
- **错误日志**: 记录所有错误和异常情况
- **性能日志**: 记录关键操作的性能指标

### 9.2 告警机制
- **更新失败告警**: EPG数据更新失败时发送告警
- **性能告警**: API响应时间过长时发送告警
- **异常告警**: 系统出现异常时发送告警

### 9.3 定期维护
- **日志清理**: 定期清理过期日志文件
- **缓存清理**: 定期清理过期缓存数据
- **数据备份**: 定期备份EPG配置和数据

## 10. 扩展功能

### 10.1 高级搜索
- **节目搜索**: 支持按标题、描述等搜索节目
- **时间范围搜索**: 支持按时间范围筛选节目
- **多条件组合搜索**: 支持多个条件的组合搜索

### 10.2 个性化推荐
- **观看历史**: 记录用户观看历史
- **推荐算法**: 基于观看历史推荐相关节目
- **收藏功能**: 支持收藏频道和节目

### 10.3 多数据源支持
- **数据源切换**: 支持多个EPG数据源的切换
- **数据融合**: 支持多个数据源的融合展示
- **区域化支持**: 支持不同地区的EPG数据

## 11. 开发计划

### 11.1 第一阶段（基础功能）
- [ ] 后端EPG服务接口设计
- [ ] XMLTV解析服务实现
- [ ] 基础API端点开发
- [ ] 前端路由和页面框架
- [ ] 频道列表展示
- [ ] 当前节目展示

### 11.2 第二阶段（核心功能）
- [ ] 分类浏览功能
- [ ] 频道详情页面
- [ ] 手动刷新功能
- [ ] 自动更新机制
- [ ] 缓存优化
- [ ] 错误处理完善

### 11.3 第三阶段（用户体验）
- [ ] 界面美化
- [ ] 响应式设计
- [ ] 加载动画
- [ ] 搜索功能
- [ ] 收藏功能
- [ ] 个性化推荐

### 11.4 第四阶段（性能优化）
- [ ] 性能测试
- [ ] 内存优化
- [ ] 网络优化
- [ ] 监控完善
- [ ] 文档完善
- [ ] 部署优化

## 12. 风险评估与应对

### 12.1 技术风险
- **XMLTV格式兼容性**: 不同数据源的XMLTV格式可能存在差异
  - 应对：增加格式验证和容错处理
- **大数据量处理**: 大型EPG文件可能导致内存问题
  - 应对：采用流式解析和分页加载

### 12.2 业务风险
- **数据源稳定性**: EPG数据源可能不稳定或不可用
  - 应对：实现数据源切换和本地缓存机制
- **更新频率**: 数据更新频率可能影响用户体验
  - 应对：优化更新策略，提供手动刷新选项

### 12.3 性能风险
- **并发访问**: 大量用户同时访问可能导致性能问题
  - 应对：实施限流和缓存策略
- **内存占用**: 缓存大量EPG数据可能导致内存问题
  - 应对：设置合理的缓存大小和过期策略

通过以上的详细设计和规划，可以确保EPG节目单模块的顺利实现和稳定运行。